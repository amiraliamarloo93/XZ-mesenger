<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>چت - XZ</title>
<link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="app-frame" style="margin:20px auto">
    <div class="left-col">
      <div class="brand"><div class="logo">XZ</div><div><h1>پیام‌رسان XZ</h1><div class="small-muted">چت‌ها</div></div></div>
      <input class="search-input" id="searchChat" placeholder="🔍 جستجو گفتگو..." oninput="filterChats()">
      <div style="margin-top:10px">
        <button class="btn" onclick="backHome()">بازگشت به خانه</button>
        <button class="btn ghost" onclick="openProfile()">پروفایل</button>
      </div>
      <div style="margin-top:10px;flex:1;overflow:auto">
        <div id="chatList" class="chats"></div>
      </div>
    </div>

    <div class="right-col">
      <div class="topbar"><div class="title" id="chatTitle">یک گفتگو انتخاب کنید</div><div class="controls"><button class="btn" id="btn-group-settings" style="display:none" onclick="groupSettings()">تنظیمات گروه</button></div></div>
      <div class="conv">
        <div class="messages" id="messages"></div>
        <div class="input-area">
          <input type="text" id="msgInput" placeholder="پیام خود را بنویسید..." onkeydown="enterSend(event)">
          <input type="file" id="fileInput" style="display:none" accept="image/*,audio/*">
          <button class="icon-btn" onclick="document.getElementById('fileInput').click()">📎</button>
          <button class="icon-btn" onclick="startRecording()">🎤</button>
          <button class="btn primary" onclick="sendMessage()">ارسال</button>
        </div>
      </div>
    </div>
  </div>

<script>
const user = JSON.parse(localStorage.getItem('user')||"null");
if(!user) location.href='index.html';
const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host);
ws.onopen = ()=> { ws.send(JSON.stringify({type:'join', phone:user.phone})); loadHistoryIfGroup(); };
ws.onmessage = (evt)=> {
  const data = JSON.parse(evt.data);
  if(data.type === 'group' && data.group === localStorage.getItem('currentGroup')){
    appendMessage(data.entry.user, data.entry.message, data.entry.kind);
  } else if(data.type === 'private'){
    // handle private
    if(data.entry.to === user.phone || data.entry.user === user.phone) appendMessage(data.entry.user, data.entry.message, data.entry.kind, true);
  } else if(data.type === 'history'){
    if(data.subtype === 'group' && data.group === localStorage.getItem('currentGroup')){
      document.getElementById('messages').innerHTML = '';
      (data.messages || []).forEach(m => appendMessage(m.user, m.message, m.kind));
    }
  }
};

function appendMessage(userId, text, kind='text', isPrivate=false){
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = userId === user.phone ? 'msg me' : 'msg other';
  if(kind === 'text'){
    div.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${userId}</div><div>${escapeHtml(text)}</div><div class="time">${new Date().toLocaleTimeString()}</div>`;
  } else if(kind === 'image'){
    div.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${userId}</div><img class="img-thumb" src="${text}" /><div class="time">${new Date().toLocaleTimeString()}</div>`;
  } else if(kind === 'voice'){
    div.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${userId}</div><audio class="audio-player" controls src="${text}"></audio><div class="time">${new Date().toLocaleTimeString()}</div>`;
  }
  container.appendChild(div);
  div.scrollIntoView({behavior:'smooth', block:'end'});
}

function escapeHtml(s){ return String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

function enterSend(e){ if(e.key === 'Enter') sendMessage(); }

function sendMessage(){
  const currentGroup = localStorage.getItem('currentGroup');
  const msg = document.getElementById('msgInput').value.trim();
  if(!currentGroup || !msg) return;
  const payload = { type:'group', group: currentGroup, user: user.phone, message: msg, kind:'text' };
  ws.send(JSON.stringify(payload));
  appendMessage(user.phone, msg, 'text');
  document.getElementById('msgInput').value = '';
}

// file upload (images/audio)
document.getElementById('fileInput').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const b64 = reader.result;
    const currentGroup = localStorage.getItem('currentGroup');
    const kind = file.type.startsWith('image/') ? 'image' : 'voice';
    const payload = { type:'group', group: currentGroup, user:user.phone, message: b64, kind };
    ws.send(JSON.stringify(payload));
    appendMessage(user.phone, b64, kind);
  };
  reader.readAsDataURL(file);
});

// recording voice
let recorder, audioChunks=[];
async function startRecording(){
  if(recorder && recorder.state === 'recording'){ recorder.stop(); return; }
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  recorder = new MediaRecorder(stream);
  audioChunks = [];
  recorder.ondataavailable = e => audioChunks.push(e.data);
  recorder.onstop = async ()=>{
    const blob = new Blob(audioChunks, { type:'audio/webm' });
    const reader = new FileReader();
    reader.onload = ()=> {
      const b64 = reader.result;
      const currentGroup = localStorage.getItem('currentGroup');
      const payload = { type:'group', group: currentGroup, user:user.phone, message: b64, kind:'voice' };
      ws.send(JSON.stringify(payload));
      appendMessage(user.phone, b64, 'voice');
    };
    reader.readAsDataURL(blob);
  };
  recorder.start();
  alert('در حال ضبط... دوباره روی میکروفون کلیک کنید تا توقف شود');
}

// load groups list on left
async function loadList(){
  const res = await fetch('/api/groups').then(r=>r.json());
  window._groups = res || {};
  renderList();
}
function renderList(){
  const el = document.getElementById('chatList'); el.innerHTML='';
  const cur = localStorage.getItem('currentGroup');
  for(const g in window._groups){
    const div = document.createElement('div'); div.className='chat-card';
    div.innerHTML = `<div class="chat-avatar">${g[0]||'G'}</div>
      <div class="chat-meta"><div class="title">${g}</div><div class="sub">${window._groups[g].description||''}</div></div>
      <div><button class="btn" onclick="enter('${encodeURIComponent(g)}')">باز</button></div>`;
    el.appendChild(div);
  }
}
function enter(nameEnc){
  const name = decodeURIComponent(nameEnc);
  localStorage.setItem('currentGroup', name);
  document.getElementById('chatTitle').innerText = name;
  // request history
  ws.send(JSON.stringify({ type:'history-request', subtype:'group', group:name }));
  document.getElementById('btn-group-settings').style.display = 'inline-block';
}
function loadHistoryIfGroup(){
  const g = localStorage.getItem('currentGroup');
  if(g){
    document.getElementById('chatTitle').innerText = g;
    ws.send(JSON.stringify({ type:'history-request', subtype:'group', group:g }));
  }
}
function backHome(){ location.href='groups.html'; }
function openProfile(){ location.href='profile.html'; }
function groupSettings(){ alert('پنل تنظیمات گروه (ویرایش نام/عکس) بعدی کامل خواهد شد'); }
function filterChats(){ /* optional */ }

loadList();
</script>
</body>
</html>
